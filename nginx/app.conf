# nginx/app.conf
# Front door on $PORT (Render) -> proxy to IBKR Gateway on https://127.0.0.1:5000
server {
  listen       0.0.0.0:$PORT default_server;
  server_name  _;

  # Always talk HTTPS to the Gateway and present the correct host/ scheme
  proxy_http_version 1.1;
  proxy_ssl_server_name on;

  proxy_set_header Host              $host;
  proxy_set_header X-Forwarded-Host  $host;
  proxy_set_header X-Forwarded-Proto https;
  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;

  # --- Cookie rewrite: make the upstream cookie valid for your public host ---
  # If upstream ever sets Domain=localhost or 127.0.0.1, rewrite to our host.
  proxy_cookie_domain localhost $host;
  proxy_cookie_domain 127.0.0.1 $host;

  # Ensure the cookie works cross-site (mobile app + browser) and over HTTPS
  # We *add* SameSite=None; Secure and normalize the Path.
  proxy_cookie_path / "/; SameSite=None; Secure";

  # Donâ€™t cache; keep streaming responses
  proxy_buffering off;

  # Redirect any absolute self-links from the upstream to our public host
  proxy_redirect https://localhost:5000/ https://$host/;
  proxy_redirect https://127.0.0.1:5000/ https://$host/;

  # Serve the whole site through the Gateway
  location / {
    proxy_pass https://127.0.0.1:5000;
  }

  # Static safety (optional)
  default_type application/octet-stream;
}


