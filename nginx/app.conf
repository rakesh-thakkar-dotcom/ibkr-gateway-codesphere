server {
  listen 10000;
  server_name _;

  # Default landing -> IBKR login
  location = / {
    return 302 /sso/Login?forwardTo=22&RL=1&ip2loc=US;
  }

  # --- SSO UI (HTML/JS/CSS) ---
  location /sso/ {
    proxy_pass https://127.0.0.1:5000;
    proxy_ssl_server_name on;

    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    # WebSocket upgrade (IBKR UI uses it occasionally)
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    # Cookies must be usable via HTTPS
    proxy_cookie_path / "/; SameSite=None; Secure";

    # Safety net: rewrite any absolute localhost URLs in HTML/JS
    sub_filter_once off;
    sub_filter_types text/html application/javascript;
    sub_filter "https://localhost:5000" "https://$host";
    sub_filter "http://localhost:5000"  "https://$host";
  }

  # --- API passthrough ---
  location /portal.proxy/ {
    proxy_pass https://127.0.0.1:5000;
    proxy_ssl_server_name on;

    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    proxy_cookie_path / "/; SameSite=None; Secure";
  }

  # Assets
  location ~* \.(css|js|png|jpg|jpeg|gif|svg|woff2?)$ {
    proxy_pass https://127.0.0.1:5000;
    proxy_ssl_server_name on;

    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto https;
  }

  # Health
  location = /healthz { return 200; }
}

# Required for WebSocket upgrade mapping
map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

