# Proxies all traffic to the IBKR HTTPS gateway on 127.0.0.1:__GATEWAY_PORT__
# and fixes redirects + cookies so the browser session sticks (no login loop).

server {
    listen 0.0.0.0:__PORT__;
    server_name _;

    # IBKR login pages send large headers sometimes
    large_client_header_buffers 8 32k;

    location / {
        proxy_pass https://127.0.0.1:__GATEWAY_PORT__;
        proxy_http_version 1.1;

        # Upstream is self-signed HTTPS, so disable verification (safe: local hop)
        proxy_ssl_verify off;
        proxy_ssl_server_name on;

        # Preserve original host + proto coming from Render
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $real_proto;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $real_port;

        # WebSockets and long-poll
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        proxy_buffering off;

        # Fix absolute redirects from the gateway
        proxy_redirect https://127.0.0.1:__GATEWAY_PORT__/ /;
        proxy_redirect https://localhost:__GATEWAY_PORT__/ /;
        proxy_redirect https://localhost/ /;

        # Make any localhost cookies usable on your public hostname
        proxy_cookie_domain 127.0.0.1 $host;
        proxy_cookie_domain localhost $host;

        # Normalize common cookie paths to root so they apply site-wide
        proxy_cookie_path /sso/ /;
        proxy_cookie_path /sso /;
        proxy_cookie_path /portal.proxy/ /;
        proxy_cookie_path /portal/ /;

        # Don't leak internal buffering hints
        proxy_hide_header X-Accel-Buffering;
    }

    location = /healthz {
        add_header Content-Type text/plain;
        return 200 "ok\n";
    }
}
