# nginx/app.conf (Template with placeholders)
# NOTE: This is loaded by entrypoint and written to /home/app/nginx-conf/conf.d/app.conf

server {
    listen 0.0.0.0:__PORT__;
    server_name _;

    # IBKR uses lots of headers/cookies; give headroom
    large_client_header_buffers 8 64k;

    # --- Main reverse proxy to the local HTTPS gateway ---
    location / {
        proxy_pass https://127.0.0.1:__GATEWAY_PORT__;
        proxy_ssl_verify off;
        proxy_ssl_server_name on;
        proxy_http_version 1.1;

        # Preserve original host & client details
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # Force what the app expects behind TLS edge
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port 443;

        # WebSocket/SSE friendliness
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_buffering off;
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;

        # Rewrite absolute redirects from the gateway
        proxy_redirect https://127.0.0.1:__GATEWAY_PORT__/ $scheme://$host/;
        proxy_redirect https://localhost:__GATEWAY_PORT__/ $scheme://$host/;
        proxy_redirect https://localhost/ $scheme://$host/;
    }

    # Simple health check
    location = /healthz { return 200 "ok\n"; add_header Content-Type text/plain; }
}


