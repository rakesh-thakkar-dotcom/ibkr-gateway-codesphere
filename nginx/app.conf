server {
  listen 0.0.0.0:$PORT;
  server_name _;

  # Never append the internal port to redirects
  absolute_redirect off;
  port_in_redirect off;

  # Send the root path to the login screen (RELATIVE redirect, no host/port)
  location = / {
    return 302 /sso/Login?forwardTo=22&RL=1&ip2loc=US;
  }

  # Everything else is proxied to the Gateway on 127.0.0.1:5000
  location / {
    proxy_http_version 1.1;
    proxy_pass https://127.0.0.1:5000;

    # Tell the app we're behind HTTPS and on this host
    proxy_set_header Host              $host;
    proxy_set_header X-Forwarded-Host  $host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-Port  443;

    # Upstream uses a self-signed cert; we terminate TLS at Render
    proxy_ssl_verify off;

    proxy_buffering off;

    # Rewrite any absolute redirects from upstream to your host (no port)
    proxy_redirect https://127.0.0.1:5000/ https://$host/;
    proxy_redirect  http://127.0.0.1:5000/ https://$host/;

    # Belt-and-suspenders: rewrite hardcoded localhost links in HTML/JS
    sub_filter_once off;
    sub_filter_types *;
    sub_filter "https://localhost:5000" "https://$host";
    sub_filter "http://localhost:5000" "https://$host";
  }
}

