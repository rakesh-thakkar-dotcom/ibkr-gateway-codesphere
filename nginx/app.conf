# nginx/app.conf

server {
  # Render will forward HTTPS -> this container on port 10000.
  listen 0.0.0.0:10000;
  server_name _;

  # (Optional) quick health check endpoint
  location = /healthz { return 200; }

  # Everything else proxies to the IBKR Client Portal Gateway (listening on 5000 inside the container).
  location / {
    proxy_pass https://127.0.0.1:5000;
    proxy_ssl_verify off;

    # Make the upstream "see" the real public request details
    proxy_http_version 1.1;
    proxy_set_header Host               $host;
    proxy_set_header X-Forwarded-Proto  https;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Host   $host;
    proxy_set_header X-Forwarded-Port   443;
    proxy_set_header Connection         "";

    # Timeouts a bit higher to avoid auth race-y drops
    proxy_read_timeout 180s;
    proxy_send_timeout 180s;

    # ---- Cookie helpers (safe & minimal) ----
    # If upstream ever sets Domain=localhost, rewrite to your public host.
    proxy_cookie_domain ~localhost $host;

    # Ensure cookies remain usable via your HTTPS public URL.
    # If your nginx doesn't support this directive, delete the line.
    proxy_cookie_flags ~ secure samesite=None;
  }
}

